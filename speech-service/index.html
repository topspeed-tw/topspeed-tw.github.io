<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å½±éŸ³å®¢æœ</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .chat-container {
            width: 400px;
            height: 700px; /* å¢åŠ é«˜åº¦ä»¥å®¹ç´å½±ç‰‡ */
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden; /* é˜²æ­¢å­å…ƒç´ æº¢å‡ºåœ†è§’ */
        }
        .video-container {
            width: 100%;
            background-color: #000;
        }
        #ai-video {
            width: 100%;
            height: auto;
            display: block;
        }
        .chat-messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background-color: #f5f7fa;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 20px;
            max-width: 75%;
            word-wrap: break-word;
            line-height: 1.4;
        }
        .user-message {
            background-color: #007bff;
            color: white;
            align-self: flex-end;
        }
        .bot-message {
            background-color: #e9e9eb;
            color: #000;
            align-self: flex-start;
        }
        .chat-input-area {
            padding: 20px 15px;
            border-top: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px; /* æŒ‰éˆ•å’Œè¼¸å…¥æ¡†ä¹‹é–“çš„é–“è· */
        }
        #voice-input-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 70px; /* æ”¾å¤§æŒ‰éˆ• */
            height: 70px; /* æ”¾å¤§æŒ‰éˆ• */
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px; /* æ”¾å¤§åœ–ç¤º */
            flex-shrink: 0;
            transition: background-color 0.2s;
        }
        #voice-input-btn:hover {
            background-color: #0056b3;
        }
        .text-input-container {
            display: flex;
            width: 100%;
            gap: 10px;
        }
        #message-input {
            flex-grow: 1;
            border: 1px solid #ccc;
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 14px;
        }
        #send-btn {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            flex-shrink: 0;
        }
    </style>
</head>
<body>

    <div class="chat-container">
        <div class="video-container">
            <!-- 
              æ³¨æ„ï¼šé€™æ˜¯ä¸€å€‹é éŒ„çš„å½±ç‰‡ä¾†ç¤ºæ„ AI é ­åƒã€‚
              æ‚¨å¯ä»¥æ›¿æ›æˆæ‚¨è‡ªå·±çš„å½±ç‰‡æª”æ¡ˆã€‚
              çœŸå¯¦çš„å³æ™‚ AI å½±ç‰‡ç”Ÿæˆéœ€è¦ä¸²æ¥å°ˆé–€çš„æœå‹™ã€‚
            -->
            <video id="ai-video" src="https://videos.pexels.com/video-files/8328434/8328434-sd_640_360_30fps.mp4" playsinline muted loop></video>
        </div>
        <div class="chat-messages" id="chat-messages">
            <!-- å°è©±å…§å®¹æœƒè¢«å‹•æ…‹åŠ å…¥é€™è£¡ -->
        </div>
        <div class="chat-input-area">
            <button id="voice-input-btn" title="èªéŸ³è¼¸å…¥">ğŸ¤</button>
            <div class="text-input-container">
                <input type="text" id="message-input" placeholder="æˆ–åœ¨æ­¤è¼¸å…¥è¨Šæ¯...">
                <button id="send-btn" title="å‚³é€">â¤</button>
            </div>
        </div>
    </div>

    <script>
        // --- å…ƒç´ ç²å– ---
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const voiceInputBtn = document.getElementById('voice-input-btn');
        const aiVideo = document.getElementById('ai-video');

        // --- Gemini API è¨­å®š ---
        // !!! è«‹å‹™å¿…æ›¿æ›æˆæ‚¨è‡ªå·±çš„ API é‡‘é‘° !!!
        const API_KEY = 'AIzaSyD7esrBZHkFnVKW3R3Tfij3sHgtH3Jjg_E';
        const MODEL_NAME = "gemini-2.5-flash";

        // --- AI ç³»çµ±æŒ‡ç¤º ---
        const SYSTEM_INSTRUCTION = "ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„æ±½è»Šä¿éšªå®¢æœå°ˆå“¡ï¼Œä»»è·æ–¼å°ç£çš„æ¥µé€Ÿè¶…è·‘ä¿éšªã€‚ä½ çš„ä»»å‹™æ˜¯åªå›ç­”èˆ‡æ±½è»Šä¿éšªç›¸é—œçš„å•é¡Œã€‚å¦‚æœä½¿ç”¨è€…è©¢å•ä»»ä½•å…¶ä»–è©±é¡Œ(ä¾‹å¦‚ï¼šå¤©æ°£ã€é£Ÿè­œã€é‹å‹•ã€å¯«ç¨‹å¼)ï¼Œä½ å¿…é ˆç¦®è²Œåœ°æ‹’çµ•ï¼Œä¸¦èªªæ˜ä½ åªèƒ½è™•ç†æ±½è»Šä¿éšªçš„è«®è©¢ã€‚è«‹ä¿æŒå‹å–„å’Œå°ˆæ¥­çš„èªæ°£ã€‚å°è©±è«‹ä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚ æ¯æ¬¡å›è¦†æ–‡å­—é•·åº¦ç›¡é‡ä¸è¦è¶…é80å€‹ä¸­æ–‡å­—";

        // --- å°è©±æ­·å²ç´€éŒ„ ---
        let conversationHistory = [];

        // --- é é¢è¼‰å…¥æ™‚çš„åˆå§‹å‹•ä½œ ---
        document.addEventListener('DOMContentLoaded', () => {
            const initialBotMessage = 'æ‚¨å¥½ï¼è«‹å•æœ‰ä»€éº¼æ±½è»Šä¿éšªç›¸é—œå•é¡Œæˆ‘å¯ä»¥ç‚ºæ‚¨è§£ç­”å—ï¼Ÿ';
            appendMessage(initialBotMessage, 'bot-message');
            conversationHistory.push({ role: 'model', parts: [{ text: initialBotMessage }] });
            // åˆå§‹æ™‚å½±ç‰‡æ˜¯æš«åœçš„
            aiVideo.pause();
        });

        // --- äº‹ä»¶ç›£è½ ---
        sendBtn.addEventListener('click', handleSendMessage);
        messageInput.addEventListener('keypress', (e) => (e.key === 'Enter') && handleSendMessage());

        // --- èªéŸ³è¼¸å…¥ & æ–‡å­—è½‰èªéŸ³ (Web Speech API) ---
        const speechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
        const speechSynthesis = window.speechSynthesis;

        if (speechRecognition) {
            const recognition = new speechRecognition();
            recognition.continuous = false;
            recognition.lang = 'zh-TW';

            voiceInputBtn.addEventListener('click', () => {
                recognition.start();
                voiceInputBtn.textContent = '...';
                voiceInputBtn.style.backgroundColor = '#dc3545'; // è®Šè‰²æç¤ºéŒ„éŸ³ä¸­
            });

            recognition.onresult = (event) => {
                messageInput.value = event.results[0][0].transcript;
                handleSendMessage(); // è¾¨è­˜å®Œç•¢å¾Œè‡ªå‹•é€å‡º
            };

            recognition.onerror = (event) => {
                console.error('èªéŸ³è¾¨è­˜éŒ¯èª¤:', event.error);
                alert('èªéŸ³è¾¨è­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥éº¥å…‹é¢¨æ¬Šé™æˆ–ç€è¦½å™¨æ”¯æ´ã€‚');
            };

            recognition.onend = () => {
                voiceInputBtn.textContent = 'ğŸ¤';
                voiceInputBtn.style.backgroundColor = '#007bff';
            };

        } else {
            voiceInputBtn.style.display = 'none';
            console.log('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¼¸å…¥åŠŸèƒ½ã€‚');
        }

        // --- æ ¸å¿ƒåŠŸèƒ½å‡½å¼ ---

        function handleSendMessage() {
            const userMessageText = messageInput.value.trim();
            if (userMessageText === '') return;

            appendMessage(userMessageText, 'user-message');
            conversationHistory.push({ role: 'user', parts: [{ text: userMessageText }] });
            messageInput.value = '';
            
            // é¡¯ç¤ºè¼‰å…¥ä¸­çš„æç¤º
            const loadingElement = appendMessage('...', 'bot-message');
            loadingElement.id = 'loading-indicator';

            getGeminiResponse(loadingElement);
        }

        async function getGeminiResponse(loadingElement) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        "contents": conversationHistory,
                        "systemInstruction": { "parts": [{ "text": SYSTEM_INSTRUCTION }] }
                    }),
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                // ç§»é™¤"..."è¼‰å…¥æç¤º
                loadingElement.remove();

                if (data.candidates && data.candidates.length > 0) {
                    const botMessageText = data.candidates[0].content.parts[0].text;
                    appendMessage(botMessageText, 'bot-message');
                    conversationHistory.push({ role: 'model', parts: [{ text: botMessageText }] });
                    
                    // *** è§¸ç™¼èªéŸ³å’Œå½±ç‰‡ ***
                    speakTextAndPlayVideo(botMessageText);
                } else {
                    handleApiError('æŠ±æ­‰ï¼ŒAI æ²’æœ‰å›å‚³æœ‰æ•ˆçš„å…§å®¹ã€‚');
                }
            } catch (error) {
                loadingElement.remove();
                console.error('Gemini API å‘¼å«å¤±æ•—:', error);
                handleApiError('æŠ±æ­‰ï¼Œé€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            }
        }
        
        function speakTextAndPlayVideo(text) {
            if (!speechSynthesis) {
                console.log('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆåŠŸèƒ½ã€‚');
                return;
            }
            // åœæ­¢ä¹‹å‰å¯èƒ½é‚„åœ¨æ’­æ”¾çš„èªéŸ³
            speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'zh-TW';
            utterance.rate = 1; // èªé€Ÿ
            utterance.pitch = 1; // éŸ³é«˜

            utterance.onstart = () => {
                aiVideo.play(); // èªéŸ³é–‹å§‹æ™‚ï¼Œæ’­æ”¾å½±ç‰‡
            };

            utterance.onend = () => {
                aiVideo.pause(); // èªéŸ³çµæŸæ™‚ï¼Œæš«åœå½±ç‰‡
            };
            
            utterance.onerror = (event) => {
                console.error('èªéŸ³åˆæˆéŒ¯èª¤:', event.error);
                aiVideo.pause(); // å¦‚æœå‡ºéŒ¯ä¹Ÿæš«åœå½±ç‰‡
            };

            speechSynthesis.speak(utterance);
        }

        function appendMessage(message, className) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', className);
            messageElement.innerText = message;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return messageElement;
        }

        function handleApiError(errorMessage) {
            appendMessage(errorMessage, 'bot-message');
            conversationHistory.push({ role: 'model', parts: [{ text: errorMessage }] });
        }
    </script>

</body>
</html>